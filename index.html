<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindClear</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MindClear">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* iOS Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34D399;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34D399;
        }

        .card-enter {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .tab-active {
            color: #2563EB;
        }
        .tab-inactive {
            color: #9CA3AF;
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header - Export Button removed -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 border-b border-gray-200 pt-12 pb-2 px-4 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-bold text-gray-900" id="headerTitle">想法库</h1>
            <p class="text-xs text-gray-500 mt-0.5" id="headerSubtitle">清空大脑，保持专注</p>
        </div>
        <div class="text-sm text-gray-400 font-medium" id="itemCount">0 条记录</div>
    </header>

    <!-- Main List Container -->
    <main id="mainContainer" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-3 pb-32">
        <!-- Content injected here -->
    </main>

    <!-- Empty State (Hidden by default) -->
    <div id="emptyState" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center opacity-40">
        <i class="fas fa-feather-alt text-5xl mb-4 text-gray-400"></i>
        <p class="text-gray-500 font-medium">大脑空空<br>非常轻松</p>
    </div>

    <!-- Add Button (FAB) -->
    <button onclick="openModal()" class="fixed bottom-24 right-6 bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center text-2xl z-20 transition-transform active:scale-90">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Bottom Tab Bar -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center safe-bottom z-20 text-xs font-medium">
        <button onclick="switchTab('ideas')" class="flex-1 py-3 flex flex-col items-center gap-1 tab-active" id="tab-ideas">
            <i class="fas fa-lightbulb text-xl"></i>
            <span>念头</span>
        </button>
        <button onclick="switchTab('todos')" class="flex-1 py-3 flex flex-col items-center gap-1 tab-inactive" id="tab-todos">
            <i class="fas fa-check-circle text-xl"></i>
            <span>待办</span>
        </button>
    </nav>

    <!-- Input Modal - Adjusted to be vertically centered on all screens -->
    <div id="inputModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <!-- Modal Panel - Unified rounded corners, added max-width for better centering -->
        <div class="bg-white w-full max-w-sm sm:rounded-2xl rounded-2xl p-4 transform translate-y-full transition-transform duration-300 ease-out" id="modalPanel">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-500 font-medium text-sm">记录新内容</span>
                <button onclick="closeModal()" class="text-gray-400 bg-gray-100 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button>
            </div>
            
            <textarea id="inputContent" rows="3" placeholder="刚才想到了什么？或者有什么任务？" class="w-full bg-gray-50 text-lg p-3 rounded-xl border-none focus:ring-2 focus:ring-blue-500 mb-4 resize-none"></textarea>
            
            <div class="flex gap-3">
                <button onclick="saveItem('idea')" class="flex-1 bg-yellow-100 text-yellow-700 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 active:bg-yellow-200">
                    <i class="fas fa-lightbulb"></i> 存为念头
                </button>
                <button onclick="saveItem('todo')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 active:bg-blue-700">
                    <i class="fas fa-check"></i> 存为待办
                </button>
            </div>
            <div class="safe-bottom h-4"></div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="alertModal" class="fixed inset-0 bg-black/40 z-[60] hidden flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs mx-4 p-6 text-center transform scale-90 transition-transform duration-300">
            <h3 id="alertTitle" class="text-lg font-semibold text-gray-900 mb-3"></h3>
            <p id="alertMessage" class="text-sm text-gray-600 mb-6"></p>
            <div id="alertButtons" class="flex gap-3">
                <!-- Buttons injected here -->
            </div>
        </div>
    </div>

    <script>
        // Data Structure
        // Item: { id, text, type: 'idea'|'todo', created, completed: boolean }
        let items = JSON.parse(localStorage.getItem('mindclear_items')) || [];
        let currentTab = 'ideas'; // 'ideas' or 'todos'

        // DOM Elements
        const mainContainer = document.getElementById('mainContainer');
        const emptyState = document.getElementById('emptyState');
        const inputModal = document.getElementById('inputModal');
        const modalPanel = document.getElementById('modalPanel');
        const inputContent = document.getElementById('inputContent');
        const headerTitle = document.getElementById('headerTitle');
        const headerSubtitle = document.getElementById('headerSubtitle');
        const itemCount = document.getElementById('itemCount');
        const alertModal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertButtons = document.getElementById('alertButtons');

        // Initial Render
        render();

        // --- Custom Alert/Confirm Functions (Replaces native confirm/alert) ---
        let resolveAlertPromise;

        /**
         * Shows a custom modal dialog (replaces native confirm/alert).
         * @param {string} title - The title of the dialog.
         * @param {string} message - The message content.
         * @param {boolean} isConfirm - If true, shows OK/Cancel buttons (confirm behavior), otherwise shows only OK (alert behavior).
         * @returns {Promise<boolean>} Resolves with true if OK/Confirm is pressed, false if Cancel is pressed (only for confirm).
         */
        function customConfirm(title, message, isConfirm = true) {
            return new Promise(resolve => {
                resolveAlertPromise = resolve;
                alertTitle.innerText = title;
                alertMessage.innerText = message;
                alertButtons.innerHTML = ''; // Clear existing buttons

                // Common Button Style
                const btnClass = "flex-1 py-2 rounded-lg font-medium transition duration-150 active:scale-[0.98]";

                // Cancel Button (for Confirm)
                if (isConfirm) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.innerText = '取消';
                    cancelBtn.className = `${btnClass} bg-gray-100 text-gray-700 hover:bg-gray-200`;
                    cancelBtn.onclick = () => { closeAlert(false); };
                    alertButtons.appendChild(cancelBtn);
                }

                // OK/Confirm Button
                const okBtn = document.createElement('button');
                okBtn.innerText = isConfirm ? '确定' : '好的';
                okBtn.className = `${btnClass} ${isConfirm ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
                okBtn.onclick = () => { closeAlert(true); };
                alertButtons.appendChild(okBtn);

                // Show modal with transition
                alertModal.classList.remove('hidden');
                void alertModal.offsetWidth; // Trigger reflow
                alertModal.classList.remove('opacity-0');
                alertModal.querySelector('div').classList.remove('scale-90');
            });
        }

        function closeAlert(result) {
            alertModal.classList.add('opacity-0');
            alertModal.querySelector('div').classList.add('scale-90');
            
            setTimeout(() => {
                alertModal.classList.add('hidden');
                if (resolveAlertPromise) {
                    resolveAlertPromise(result);
                    resolveAlertPromise = null;
                }
            }, 300);
        }

        // --- Core Functions ---

        function switchTab(tab) {
            currentTab = tab;
            
            // Update UI Tabs
            document.getElementById('tab-ideas').className = `flex-1 py-3 flex flex-col items-center gap-1 ${tab === 'ideas' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('tab-todos').className = `flex-1 py-3 flex flex-col items-center gap-1 ${tab === 'todos' ? 'tab-active' : 'tab-inactive'}`;
            
            // Update Header
            if (tab === 'ideas') {
                headerTitle.innerText = "想法库";
                headerSubtitle.innerText = "捕捉每一个闪念";
            } else {
                headerTitle.innerText = "待办清单";
                headerSubtitle.innerText = "一件一件完成";
            }

            render();
        }

        function render() {
            mainContainer.innerHTML = '';
            
            // Filter Items
            const filteredItems = items
                .filter(item => item.type === (currentTab === 'ideas' ? 'idea' : 'todo'))
                .sort((a, b) => b.created - a.created); // Newest first

            itemCount.innerText = `${filteredItems.length} 条`;

            if (filteredItems.length === 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                filteredItems.forEach(item => {
                    const el = createItemElement(item);
                    mainContainer.appendChild(el);
                });
            }
        }

        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = `bg-white p-4 rounded-xl shadow-sm flex items-start gap-3 card-enter ${item.completed ? 'opacity-50' : ''}`;
            
            const date = new Date(item.created);
            // Format time as M/D HH:MM
            const timeStr = `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

            let actionBtn = '';
            let icon = '';

            if (item.type === 'idea') {
                icon = `<div class="mt-1 text-yellow-500"><i class="fas fa-lightbulb"></i></div>`;
                // Convert Idea to Todo Button
                actionBtn = `
                    <button onclick="convertToTodo(${item.id})" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-medium ml-auto transition-colors active:scale-[0.98]">
                        转为待办
                    </button>
                `;
            } else {
                // Checkbox for Todo
                const checkIcon = item.completed ? 'fa-check-square text-blue-500' : 'fa-square text-gray-300';
                icon = `<button onclick="toggleTodo(${item.id})" class="mt-1 text-2xl transition-colors active:scale-95"><i class="far ${checkIcon}"></i></button>`;
            }

            // Delete Button
            const deleteBtn = `
                <button onclick="deleteItem(${item.id})" class="text-gray-300 hover:text-red-500 p-2 -mr-2 transition-colors active:scale-95">
                    <i class="fas fa-times"></i>
                </button>
            `;

            div.innerHTML = `
                ${icon}
                <div class="flex-1 min-w-0">
                    <p class="text-gray-800 text-base leading-relaxed break-words ${item.completed ? 'line-through text-gray-400' : ''}">${item.text}</p>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs text-gray-400">${timeStr}</span>
                        <div class="flex items-center gap-2">
                            ${actionBtn}
                            ${deleteBtn}
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        // --- Data Logic ---

        function saveItem(type) {
            const text = inputContent.value.trim();
            if (!text) return;

            const newItem = {
                id: Date.now(),
                text: text,
                type: type, // 'idea' or 'todo'
                created: Date.now(),
                completed: false
            };

            items.unshift(newItem);
            localStorage.setItem('mindclear_items', JSON.stringify(items));
            
            closeModal();
            
            // Auto switch to the tab where we added the item
            if (currentTab !== 'ideas' && type === 'idea') switchTab('ideas');
            else if (currentTab !== 'todos' && type === 'todo') switchTab('todos');
            else render();
        }

        async function deleteItem(id) {
            const confirmed = await customConfirm('确认删除', '这条记录将被永久删除，确定吗？');
            if (confirmed) {
                items = items.filter(i => i.id !== id);
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render();
            }
        }

        function toggleTodo(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render();
            }
        }

        function convertToTodo(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.type = 'todo';
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                
                // Optional: switch to todo tab to show it landed there
                switchTab('todos');
            }
        }

        // --- Modal Logic ---

        function openModal() {
            // 1. Remove display: none immediately so element exists
            inputModal.classList.remove('hidden');
            
            // 2. CRITICAL FOR iOS: Focus immediately. 
            // We must call focus() synchronously within the user's click event.
            // If we wait for animation or setTimeout, iOS blocks the keyboard.
            inputContent.focus();

            // 3. Trigger Animations
            // Force reflow to ensure transition plays
            void inputModal.offsetWidth;
            inputModal.classList.remove('opacity-0');
            modalPanel.classList.remove('translate-y-full');
        }

        function closeModal() {
            inputModal.classList.add('opacity-0');
            modalPanel.classList.add('translate-y-full');
            setTimeout(() => {
                inputModal.classList.add('hidden');
                inputContent.value = '';
                // Blur to hide keyboard
                inputContent.blur();
            }, 300);
        }

        // Close modal if clicking outside
        inputModal.addEventListener('click', (e) => {
            if (e.target === inputModal) closeModal();
        });
    </script>
</body>
</html>