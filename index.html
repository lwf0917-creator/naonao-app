<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindClear</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MindClear">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .font-sans-safe {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        }

        .card-enter {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .tab-active { font-weight: 600; }
        .tab-inactive { color: #9CA3AF; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .minimal-input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        .minimal-input::placeholder { color: #D1D5DB; }

        .subtask-item { transition: all 0.3s ease; }
        .subtask-done { color: #9CA3AF; text-decoration: line-through; }

        /* Error Shake */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-error {
            animation: shake 0.3s ease-in-out;
            border-bottom: 2px solid #EF4444; 
        }

        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        #completedList {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }
        .chevron-rotate { transition: transform 0.3s ease; }

        /* STRICT 3-Line Clamp */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
            max-height: 4.5em; 
        }
        .whitespace-pre-wrap-custom {
            white-space: pre-wrap; 
            word-wrap: break-word;
            word-break: break-all;
        }

        /* List Item Structure - Fixed Time */
        .list-item-wrapper {
            background: white;
            border-radius: 0.75rem; 
            margin-bottom: 0.75rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            overflow: hidden; 
            position: relative;
        }
        
        /* Fixed Time Column on Left */
        .time-col-fixed {
            flex-shrink: 0;
            width: 3.5rem; 
            border-right: 1px solid #F3F4F6;
            background-color: rgba(249, 250, 251, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20; 
        }

        /* Swipeable Area */
        .swipe-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .swipe-actions {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 0;
        }
        
        .swipe-content {
            position: relative;
            z-index: 10;
            background: white;
            height: 100%;
            transition: transform 0.2s ease-out;
            padding: 0.75rem 1rem; 
            display: flex;
            /* Critical for alignment: Start */
            align-items: flex-start; 
        }

        /* Modal Slider Styles */
        .modal-slider-container {
            display: flex;
            width: 200%; 
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .modal-slide {
            width: 50%; 
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; 
            padding-left: 1.5rem; 
            padding-right: 1.5rem; 
            padding-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        .pagination-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #E5E7EB;
            transition: all 0.3s;
        }
        .pagination-dot.active {
            background-color: #3B82F6;
            width: 12px;
            border-radius: 3px;
        }
        
        input[type="datetime-local"] { font-family: inherit; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans-safe">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 border-b border-gray-200 pt-12 pb-3 px-4 relative flex justify-center items-end">
        <div class="text-center">
            <h1 class="text-[25px] font-bold text-gray-900" id="headerTitle">念头</h1>
            <p class="text-[10px] text-gray-500 mt-0.5" id="headerSubtitle">大脑用来思考，系统用来记录</p>
        </div>
        <div class="absolute right-4 bottom-3.5 text-xs text-gray-400 font-medium" id="itemCount">0 条记录</div>
    </header>

    <!-- Main List Container -->
    <main id="mainContainer" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-3 pb-32">
        <!-- Content injected here -->
    </main>

    <!-- Add Button (FAB) -->
    <button onclick="openModal(true)" class="fixed bottom-24 right-6 bg-red-500 hover:bg-red-600 text-white w-14 h-14 rounded-full shadow-lg shadow-red-500/30 flex items-center justify-center text-2xl z-20 transition-transform active:scale-90 z-30">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Bottom Tab Bar -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center safe-bottom z-20 text-xs font-medium">
        <button onclick="switchTab('ideas')" class="flex-1 py-3 flex flex-col items-center gap-1 transition-colors duration-200" id="tab-ideas">
            <i class="fas fa-lightbulb text-xl"></i>
            <span>念头</span>
        </button>
        <button onclick="switchTab('todos')" class="flex-1 py-3 flex flex-col items-center gap-1 transition-colors duration-200" id="tab-todos">
            <i class="fas fa-check-circle text-xl"></i>
            <span>待办</span>
        </button>
    </nav>

    <!-- Detailed Edit Modal -->
    <div id="inputModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center transition-opacity duration-200 opacity-0">
        <!-- Modal Panel -->
        <div class="bg-white w-full sm:max-w-md h-[85vh] sm:h-[80vh] sm:rounded-2xl rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out flex flex-col overflow-hidden" id="modalPanel">
            
            <!-- FIXED HEADER AREA (Padding inside) -->
            <div class="flex-shrink-0 px-6 pt-6 pb-2 bg-white z-20 border-b border-gray-50">
                <!-- Top Row: Title Input & Actions -->
                <div class="flex justify-between items-start mb-1">
                    <div class="flex-1 mr-3 relative">
                        <!-- Title Input -->
                        <textarea id="inputTitle" rows="1" placeholder="记点什么好..." class="minimal-input text-xl font-bold text-gray-900 resize-none leading-tight" oninput="autoResize(this); updateTitleCount();"></textarea>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button onclick="copyTitle()" class="text-gray-400 hover:text-blue-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-50" title="复制标题">
                            <i class="far fa-copy"></i>
                        </button>
                        <button onclick="closeModal()" class="text-gray-400 bg-gray-100 w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                
                <!-- Second Row: Title Count Only -->
                <div class="flex justify-end items-center gap-2 mb-4 pr-1">
                    <div id="titleCountDisplay" class="text-[10px] text-gray-300 font-medium">0</div>
                </div>

                <!-- Third Row: Time Picker (Fixed) -->
                <div class="flex items-center gap-3 text-gray-600 bg-gray-50 p-3 rounded-xl relative">
                    <i class="far fa-clock text-lg text-gray-400"></i>
                    <input type="datetime-local" id="inputTime" class="bg-transparent border-none outline-none text-sm font-medium w-full text-gray-700 font-sans-safe">
                </div>
            </div>
            
            <!-- SCROLLABLE/SWIPEABLE CONTENT AREA -->
            <div class="flex-1 overflow-hidden relative w-full mt-2">
                <div class="modal-slider-container" id="modalSlider">
                    
                    <!-- Slide 1: Details -->
                    <div class="modal-slide">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2">详细</h4>
                        <!-- Wrapper to allow scrolling and sticky bottom tools -->
                        <div class="relative w-full flex-1 flex flex-col min-h-0">
                            <!-- Textarea: Added pb-10 to prevent text under floating tools -->
                            <textarea id="inputDesc" class="minimal-input text-base text-gray-700 resize-none w-full pb-10" placeholder="添加详细内容..." oninput="autoResize(this); updateDescCount();"></textarea>
                            
                            <!-- Floating Tools: Follows text flow (at bottom of flex container or absolute bottom of relative container) -->
                            <div id="descTools" class="absolute bottom-0 right-0 flex items-center gap-2 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-lg border border-gray-100 shadow-sm transition-all" style="display: none;">
                                <span id="descCountDisplay" class="text-[10px] text-gray-400">0</span>
                                <div class="w-px h-3 bg-gray-200"></div>
                                <button onclick="copyDesc()" class="text-gray-400 hover:text-blue-500 text-xs">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Slide 2: Subtasks -->
                    <div class="modal-slide">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 mt-2">小分类</h4>
                        <div id="subtasksList" class="space-y-2 mb-3"></div>
                        <div class="flex items-center gap-3 text-gray-400 mt-4 border-t border-dashed border-gray-200 pt-4">
                            <i class="fas fa-plus text-sm ml-1"></i>
                            <input type="text" id="newSubtaskInput" placeholder="添加新分类..." class="minimal-input text-base" onkeypress="handleSubtaskEnter(event)">
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer Fixed Area -->
            <div class="flex-shrink-0 bg-white border-t border-gray-100 px-6 pt-2 pb-safe-bottom z-20">
                <!-- Pagination Dots -->
                <div class="flex justify-center gap-1.5 mb-3" id="paginationDots">
                    <div class="pagination-dot active"></div>
                    <div class="pagination-dot"></div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mb-4 safe-bottom">
                    <button id="btnSaveIdea" onclick="saveItem('idea')" class="flex-1 bg-yellow-100 text-yellow-700 py-3.5 rounded-xl font-semibold flex items-center justify-center gap-2 active:bg-yellow-200 transition-transform active:scale-[0.98]">
                        <i class="fas fa-lightbulb"></i> 收入念头
                    </button>
                    <button id="btnSaveTodo" onclick="saveItem('todo')" class="flex-1 bg-red-500 text-white py-3.5 rounded-xl font-semibold flex items-center justify-center gap-2 active:bg-red-600 shadow-sm transition-transform active:scale-[0.98]">
                        <i class="fas fa-check"></i> 设为待办
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-black/40 z-[60] hidden flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs mx-4 p-6 text-center transform scale-90 transition-transform duration-300">
            <h3 id="alertTitle" class="text-lg font-semibold text-gray-900 mb-3"></h3>
            <p id="alertMessage" class="text-sm text-gray-600 mb-6"></p>
            <div id="alertButtons" class="flex gap-3"></div>
        </div>
    </div>

    <script>
        let items = JSON.parse(localStorage.getItem('mindclear_items')) || [];
        let editingItemId = null; 
        let currentTab = 'ideas'; 
        let tempSubtasks = []; 
        let isCompletedOpen = false; 
        let currentModalPage = 0; 

        // DOM Elements
        const mainContainer = document.getElementById('mainContainer');
        const inputModal = document.getElementById('inputModal');
        const modalPanel = document.getElementById('modalPanel');
        const modalSlider = document.getElementById('modalSlider');
        const paginationDots = document.getElementById('paginationDots');
        
        const inputTitle = document.getElementById('inputTitle');
        const inputDesc = document.getElementById('inputDesc');
        const inputTime = document.getElementById('inputTime');
        const subtasksList = document.getElementById('subtasksList');
        const newSubtaskInput = document.getElementById('newSubtaskInput');
        
        const btnSaveTodo = document.getElementById('btnSaveTodo');
        const btnSaveIdea = document.getElementById('btnSaveIdea');
        const headerTitle = document.getElementById('headerTitle');
        const itemCount = document.getElementById('itemCount');
        const titleCountDisplay = document.getElementById('titleCountDisplay');
        const descCountDisplay = document.getElementById('descCountDisplay');
        const descTools = document.getElementById('descTools');
        const alertModal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertButtons = document.getElementById('alertButtons');

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            if(el.id === 'inputDesc') updateDescCount();
        }

        function toLocalISOString(date) {
            const tzOffset = (new Date()).getTimezoneOffset() * 60000;
            return (new Date(date - tzOffset)).toISOString().slice(0, 16);
        }

        // Initialize
        const todoCount = items.filter(i => i.type === 'todo').length;
        const ideaCount = items.filter(i => i.type === 'idea').length;
        if (todoCount === 0 && ideaCount > 0) {
            currentTab = 'ideas';
        }
        switchTab(currentTab);

        // --- Core ---
        function switchTab(tab) {
            currentTab = tab;
            const todoBtn = document.getElementById('tab-todos');
            const ideaBtn = document.getElementById('tab-ideas');

            todoBtn.className = "flex-1 py-3 flex flex-col items-center gap-1 transition-colors duration-200";
            ideaBtn.className = "flex-1 py-3 flex flex-col items-center gap-1 transition-colors duration-200";

            if (tab === 'todos') {
                todoBtn.classList.add('text-red-500', 'tab-active');
                ideaBtn.classList.add('text-gray-400', 'tab-inactive');
                headerTitle.innerText = "待办清单";
            } else {
                todoBtn.classList.add('text-gray-400', 'tab-inactive');
                ideaBtn.classList.add('text-yellow-600', 'tab-active');
                headerTitle.innerText = "念头";
            }
            render();
        }

        function render() {
            mainContainer.innerHTML = '';
            const tabItems = items.filter(item => item.type === (currentTab === 'ideas' ? 'idea' : 'todo'));
            const activeItems = tabItems.filter(item => !item.completed);
            const completedItems = tabItems.filter(item => item.completed);

            if (currentTab === 'todos') {
                activeItems.sort((a, b) => (a.targetTime || a.created) - (b.targetTime || b.created));
                completedItems.sort((a, b) => (a.targetTime || a.created) - (b.targetTime || b.created));
            } else {
                activeItems.sort((a, b) => (b.ideaUpdated || b.created) - (a.ideaUpdated || a.created));
                completedItems.sort((a, b) => (b.ideaUpdated || b.created) - (a.ideaUpdated || a.created));
            }

            itemCount.innerText = `${activeItems.length} 条`;

            activeItems.forEach(item => mainContainer.appendChild(createSwipeItem(item, false)));

            if (completedItems.length > 0) {
                const completedSection = document.createElement('div');
                completedSection.className = "mt-6";
                const header = document.createElement('div');
                header.className = "flex justify-between items-center py-3 px-2 cursor-pointer text-gray-500 font-medium text-sm select-none";
                header.onclick = toggleCompletedList;
                const chevronClass = isCompletedOpen ? "transform rotate-90" : "";
                header.innerHTML = `<span>折叠起来啦</span><div class="flex items-center gap-2"><span>${completedItems.length}</span><i class="fas fa-chevron-right text-xs transition-transform duration-300 ${chevronClass}"></i></div>`;
                completedSection.appendChild(header);

                const listContainer = document.createElement('div');
                listContainer.id = "completedList";
                listContainer.className = "space-y-3";
                if (!isCompletedOpen) listContainer.style.display = 'none';

                completedItems.forEach(item => listContainer.appendChild(createSwipeItem(item, true)));
                completedSection.appendChild(listContainer);
                mainContainer.appendChild(completedSection);
            }
        }

        function toggleCompletedList() {
            isCompletedOpen = !isCompletedOpen;
            render();
        }

        // --- NEW: List Item Structure with FIXED Time ---
        function createSwipeItem(item, isCompleted) {
            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = "list-item-wrapper card-enter";
            if(isCompleted) wrapper.classList.add('opacity-60');

            // 1. Fixed Time Column
            const displayTime = item.targetTime ? new Date(item.targetTime) : new Date(item.created);
            const yearStr = `${displayTime.getFullYear()}`;
            const dateStr = `${displayTime.getMonth()+1}/${displayTime.getDate()}`;
            const timeStr = `${String(displayTime.getHours()).padStart(2, '0')}:${String(displayTime.getMinutes()).padStart(2, '0')}`;
            
            const timeCol = document.createElement('div');
            timeCol.className = "time-col-fixed";
            // Added Year at the top
            timeCol.innerHTML = `
                <span class="text-[10px] font-medium text-gray-400 font-sans-safe leading-none mb-0.5">${yearStr}</span>
                <span class="text-xs font-bold text-gray-500 mb-0.5 font-sans-safe leading-none">${dateStr}</span>
                <span class="text-xs font-medium text-gray-400 font-sans-safe leading-none">${timeStr}</span>
            `;
            wrapper.appendChild(timeCol);

            // 2. Swipe Area
            const swipeArea = document.createElement('div');
            swipeArea.className = "swipe-area";

            const actions = document.createElement('div');
            actions.className = "swipe-actions";
            const convertColor = item.type === 'idea' ? 'bg-red-500' : 'bg-yellow-500';
            const convertIcon = item.type === 'idea' ? 'fa-check-circle' : 'fa-lightbulb';
            const completeColor = 'bg-green-500';
            const completeIcon = isCompleted ? 'fa-undo' : 'fa-check';

            actions.innerHTML = `
                <div class="absolute inset-y-0 left-0 w-1/2 ${convertColor} flex items-center justify-start pl-4 text-white font-bold"><i class="fas ${convertIcon}"></i></div>
                <div class="absolute inset-y-0 right-0 w-1/2 ${completeColor} flex items-center justify-end pr-4 text-white font-bold"><i class="fas ${completeIcon}"></i></div>
            `;
            swipeArea.appendChild(actions);

            const content = document.createElement('div');
            content.className = "swipe-content";
            
            const hasSubtasks = (item.subtasks && item.subtasks.length > 0);
            const hasDesc = (item.desc && item.desc.trim().length > 0);
            // Icon fixed at Left Top
            const detailIcon = (hasSubtasks || hasDesc) ? `<div class="mr-2 mt-1 flex-shrink-0 text-gray-300 text-xs"><i class="far fa-file-alt"></i></div>` : '';
            const textStyle = item.completed ? 'text-gray-400 line-through' : 'text-gray-800';

            // REMOVE WHITESPACE around item.text to prevent weird indent
            content.innerHTML = `
                <div class="flex items-start w-full text-left">
                    ${detailIcon}
                    <div class="flex-1 min-w-0">
                        <div class="${textStyle} text-base font-medium whitespace-pre-wrap-custom break-words line-clamp-3">${item.text}</div>
                    </div>
                </div>
            `;
            swipeArea.appendChild(content);
            wrapper.appendChild(swipeArea);

            // Swipe Logic
            let startX = 0;
            let currentTranslate = 0;
            let isDragging = false;
            let startY = 0;

            content.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                content.style.transition = 'none'; 
            }, {passive: true});

            content.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isDragging = false; 
                    return;
                }

                if (diffX > 100) currentTranslate = 100 + (diffX - 100) * 0.2;
                else if (diffX < -100) currentTranslate = -100 + (diffX + 100) * 0.2;
                else currentTranslate = diffX;
                content.style.transform = `translateX(${currentTranslate}px)`;
            }, {passive: true});

            content.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = 'transform 0.3s ease-out';
                if (currentTranslate > 80) {
                    content.style.transform = `translateX(100%)`; 
                    setTimeout(() => {
                        if (item.type === 'idea') convertToTodo(item.id);
                        else convertToIdea(item.id);
                    }, 200);
                } else if (currentTranslate < -80) {
                    content.style.transform = `translateX(-100%)`; 
                    setTimeout(() => { toggleTodo(item.id); }, 200);
                } else {
                    content.style.transform = 'translateX(0)';
                }
                currentTranslate = 0;
            });
            
            content.addEventListener('click', () => {
                if (Math.abs(currentTranslate) < 5) editItem(item.id);
            });

            return wrapper;
        }

        // --- Subtask ---
        function renderSubtasksList() {
            subtasksList.innerHTML = '';
            tempSubtasks.sort((a, b) => (a.done === b.done ? 0 : a.done ? 1 : -1));
            tempSubtasks.forEach((sub, index) => {
                const div = document.createElement('div');
                div.className = 'subtask-item flex items-start gap-3 p-1';
                const iconClass = sub.done ? 'fa-check-square text-gray-400' : 'fa-square text-gray-300';
                const textClass = sub.done ? 'subtask-done' : 'text-gray-700';
                div.innerHTML = `
                    <button onclick="toggleSubtask(${index})" class="mt-1 text-lg active:scale-90"><i class="far ${iconClass}"></i></button>
                    <input type="text" value="${sub.text}" class="minimal-input text-base ${textClass}" oninput="updateSubtaskText(${index}, this.value)">
                    <button onclick="deleteSubtask(${index})" class="text-gray-300 hover:text-red-400 ml-2 px-2"><i class="fas fa-times"></i></button>
                `;
                subtasksList.appendChild(div);
            });
        }
        function addSubtask() {
            const val = newSubtaskInput.value.trim();
            if (val) { tempSubtasks.push({ text: val, done: false }); newSubtaskInput.value = ''; renderSubtasksList(); }
        }
        function handleSubtaskEnter(e) { if (e.key === 'Enter') addSubtask(); }
        function toggleSubtask(index) { tempSubtasks[index].done = !tempSubtasks[index].done; renderSubtasksList(); }
        function updateSubtaskText(index, val) { tempSubtasks[index].text = val; }
        function deleteSubtask(index) { tempSubtasks.splice(index, 1); renderSubtasksList(); }

        // --- Counts & Copy ---
        function updateTitleCount() {
            const count = inputTitle.value.length;
            titleCountDisplay.innerText = `${count}`;
        }

        function updateDescCount() {
            const count = inputDesc.value.length;
            descCountDisplay.innerText = `${count} 字`;
            if (count > 0) {
                descTools.style.display = 'flex';
            } else {
                descTools.style.display = 'none';
            }
        }

        function updateWordCount() {
            updateTitleCount();
            updateDescCount();
        }

        function copyTitle() {
            const title = inputTitle.value.trim();
            if(!title) return;
            copyTextToClipboard(title, document.querySelector('button[onclick="copyTitle()"]'));
        }

        function copyDesc() {
            const desc = inputDesc.value.trim();
            if(!desc) return;
            copyTextToClipboard(desc, document.querySelector('button[onclick="copyDesc()"]'));
        }

        function copyTextToClipboard(text, btnElement) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                if (navigator.vibrate) navigator.vibrate(50);
                if(btnElement) {
                    const original = btnElement.innerHTML;
                    btnElement.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                    setTimeout(() => btnElement.innerHTML = original, 1000);
                }
            } catch (err) {}
            document.body.removeChild(textArea);
        }

        // --- Modal Slider Logic ---
        let sliderStartX = 0;
        let sliderStartY = 0;
        let sliderIsDragging = false;

        modalSlider.addEventListener('touchstart', (e) => {
            sliderStartX = e.touches[0].clientX;
            sliderStartY = e.touches[0].clientY;
            sliderIsDragging = true;
        }, {passive: true});

        modalSlider.addEventListener('touchend', (e) => {
            if (!sliderIsDragging) return;
            sliderIsDragging = false;
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = sliderStartX - endX;
            const diffY = sliderStartY - endY;

            // Check if horizontal swipe dominant
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 50) {
                    if (currentModalPage === 0) setModalPage(1);
                } else if (diffX < -50) {
                    if (currentModalPage === 1) setModalPage(0);
                }
            }
        });

        function setModalPage(pageIndex) {
            currentModalPage = pageIndex;
            const translateVal = pageIndex * -50; 
            modalSlider.style.transform = `translateX(${translateVal}%)`;
            
            const dots = paginationDots.children;
            if(pageIndex === 0) {
                dots[0].classList.add('active');
                dots[1].classList.remove('active');
            } else {
                dots[0].classList.remove('active');
                dots[1].classList.add('active');
            }
        }

        // --- Edit/Save ---
        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            editingItemId = id;
            inputTitle.value = item.text || '';
            inputDesc.value = item.desc || '';
            tempSubtasks = (item.subtasks && Array.isArray(item.subtasks)) ? JSON.parse(JSON.stringify(item.subtasks)) : [];
            inputTime.value = toLocalISOString(new Date(item.targetTime || item.created));
            newSubtaskInput.value = '';
            
            autoResize(inputTitle);
            updateWordCount();
            renderSubtasksList();
            
            if (item.type === 'todo') {
                btnSaveTodo.innerHTML = '<i class="fas fa-check"></i> 保存';
                btnSaveIdea.innerHTML = '<i class="fas fa-lightbulb"></i> 转为念头';
            } else {
                btnSaveIdea.innerHTML = '<i class="fas fa-lightbulb"></i> 保存';
                btnSaveTodo.innerHTML = '<i class="fas fa-check"></i> 转为待办';
            }
            openModal(false);
        }

        function saveItem(type) {
            let text = inputTitle.value.trim();
            const desc = inputDesc.value.trim();
            const targetTime = inputTime.value ? new Date(inputTime.value).getTime() : Date.now();
            const pendingSub = newSubtaskInput.value.trim();
            if (pendingSub) tempSubtasks.push({ text: pendingSub, done: false });

            // STRICT TITLE REQUIREMENT - NO AUTO FILL
            if (!text) {
                inputTitle.classList.add('shake-error');
                setTimeout(() => inputTitle.classList.remove('shake-error'), 300);
                inputTitle.focus();
                return;
            }

            if (editingItemId) {
                const idx = items.findIndex(i => i.id === editingItemId);
                if (idx > -1) {
                    items[idx].text = text;
                    items[idx].desc = desc;
                    items[idx].subtasks = tempSubtasks; 
                    delete items[idx].subtasksText;
                    items[idx].type = type;
                    items[idx].targetTime = targetTime;
                    if (type === 'idea' && items[idx].type !== 'idea') items[idx].ideaUpdated = Date.now();
                }
            } else {
                const now = Date.now();
                items.unshift({
                    id: now, text: text, desc: desc, subtasks: tempSubtasks, type: type, 
                    created: now, targetTime: targetTime, ideaUpdated: type === 'idea' ? now : null, completed: false
                });
            }
            localStorage.setItem('mindclear_items', JSON.stringify(items));
            closeModal();
            render(); 
        }

        // --- Utils (same as before) ---
        async function deleteItem(id) {
            const confirmed = await customConfirm('确认删除', '是否将此项永久移除？');
            if (confirmed) {
                items = items.filter(i => i.id !== id);
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render();
            }
        }
        function toggleTodo(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render();
            }
        }
        function convertToTodo(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.type = 'todo';
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render();
            }
        }
        function convertToIdea(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.type = 'idea';
                item.completed = false;
                item.ideaUpdated = Date.now(); 
                localStorage.setItem('mindclear_items', JSON.stringify(items));
                render(); 
            }
        }

        // --- Modal/Alert Helpers ---
        function customConfirm(title, message, isConfirm = true) {
            return new Promise(resolve => {
                alertTitle.innerText = title;
                alertMessage.innerText = message;
                alertButtons.innerHTML = ''; 
                const btnClass = "flex-1 py-2 rounded-lg font-medium transition duration-150 active:scale-[0.98]";
                if (isConfirm) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.innerText = '取消';
                    cancelBtn.className = `${btnClass} bg-gray-100 text-gray-700 hover:bg-gray-200`;
                    cancelBtn.onclick = () => closeAlert(false);
                    alertButtons.appendChild(cancelBtn);
                }
                const okBtn = document.createElement('button');
                okBtn.innerText = isConfirm ? '确定' : '好的';
                okBtn.className = `${btnClass} ${isConfirm ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-blue-500 text-white hover:bg-blue-600'}`;
                okBtn.onclick = () => closeAlert(true);
                alertButtons.appendChild(okBtn);
                window._alertResolve = resolve;
                alertModal.classList.remove('hidden');
                void alertModal.offsetWidth;
                alertModal.classList.remove('opacity-0');
                alertModal.querySelector('div').classList.remove('scale-90');
            });
        }
        function closeAlert(result) {
            alertModal.classList.add('opacity-0');
            alertModal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                alertModal.classList.add('hidden');
                if (window._alertResolve) { window._alertResolve(result); window._alertResolve = null; }
            }, 300);
        }
        function openModal(reset = true) {
            inputModal.classList.remove('hidden');
            if (reset) {
                editingItemId = null;
                inputTitle.value = '';
                inputDesc.value = '';
                newSubtaskInput.value = ''; 
                tempSubtasks = []; 
                subtasksList.innerHTML = '';
                inputTime.value = toLocalISOString(new Date());
                btnSaveIdea.innerHTML = '<i class="fas fa-lightbulb"></i> 收入念头';
                btnSaveTodo.innerHTML = '<i class="fas fa-check"></i> 设为待办';
                
                setModalPage(0);
                updateWordCount();
            }
            setTimeout(() => inputTitle.focus(), 10);
            void inputModal.offsetWidth;
            inputModal.classList.remove('opacity-0');
            modalPanel.classList.remove('translate-y-full');
            autoResize(inputTitle);
        }
        function closeModal() {
            inputModal.classList.add('opacity-0');
            modalPanel.classList.add('translate-y-full');
            setTimeout(() => {
                inputModal.classList.add('hidden');
                inputTitle.blur();
                inputDesc.blur();
                newSubtaskInput.blur();
            }, 300);
        }
        inputModal.addEventListener('click', (e) => {
            if (e.target === inputModal) closeModal();
        });
    </script>
</body>
</html>